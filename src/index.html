<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Test Page</title>
        <script src="js/jquery.js"></script>
        <script src="js/Converter.js"></script>
        <script src="js/Globals.js"></script>
        <script src="js/ImageBuffer.js"></script>
        <script src="js/BinVis.js"></script>
        <script src="js/UserInterface.js"></script>
        <script src="js/VisualPanel.js"></script>
        <script src="js/BytemapPanel.js"></script>
        <script src="js/DigraphPanel.js"></script>
        <script src="js/DotPlotPanel.js"></script>
        <script src="js/FileBuffer.js"></script>
        <script>

            function init() {
                BinVis.initialize(); // initialize app

                // event handler for file uploader
                $("#upload-file").change(fileSelectedEvent);

                // setup event handlers for offset configurator
                $("#offset-slider").change(offset_slider_changed);

                // event handler for keypresses
                $("body").keypress(handle_keypresses);
            }

            // when a new file is selected
            function fileSelectedEvent() {
                console.log("File selected");

                BinVis.loadFile($("#upload-file")[0].files[0]);
                var o = $("#offset-slider")[0];
                o.max = (BinVis.dataLength - 1).toString();
                o.value = "0";
                offset_slider_changed();
            }

            // when the button for upload is clicked
            function uploadInvoke() {
                document.getElementById("upload-file").click();
            }

            // when offset slider is changed
            function offset_slider_changed() {
                document.getElementById("offset-text").value = document.getElementById("offset-slider").value;
                var a = document.getElementById("offset-slider").value;
                var val = parseInt(a, 10);
                BinVis.setDataOffset(val);
            }

            // handles keypresses globally
            function handle_keypresses(evt) {

                if (!FileBuffer.file || BinVis.fileLoadingPhase != Globals.FILE_LOADED)
                    return 0;

                var handled = false;
                switch (evt.target.id) {

                    case "offset-text": // offset textbox
                        if (evt.keyCode == 13) // ENTER
                        {
                            var a = document.getElementById("offset-text").value;
                            var val = parseInt(a, 10);
                            if (val == NaN) {
                                document.getElementById("offset-text").value = document.getElementById("offset-slider").value;
                            }
                            else {
                                if (val < 0) val = 0;
                                if (val >= BinVis.dataLength) val = BinVis.dataLength - 1;
                                document.getElementById("offset-slider").value = val.toString();
                                offset_slider_changed();
                            }
                        }
                        handled = true;
                        break;

                    case "offset-slider": // offset slider
                        offset_slider_changed();
                        handled = true;
                        break;
                }

                if (!handled) {
                    // keypress directed to document body

                    var o = $("#offset-slider")[0];
                    var curVal = parseInt(o.value);
                    var largeOff = Math.ceil(0.005 * BinVis.dataLength);
                    
                    switch (evt.keyCode) {
                        case 37: // Arrow left
                            evt.preventDefault();
                            break;
                        case 38: // Arrow up
                            curVal -= (evt.ctrlKey ? largeOff : 1);
                            evt.preventDefault();
                            break;

                        case 39: // Arrow right
                            evt.preventDefault();
                            break;
                        case 40: // Arrow down
                            curVal += (evt.ctrlKey ? largeOff : 1);
                            evt.preventDefault();
                            break;

                        default:
                            // pass key args to user interface
                            if (UserInterface.onkeypress)
                                UserInterface.onkeypress(evt);
                            break;
                    }

                    // clamp
                    if (curVal < 0) curVal = 0;
                    if (curVal > BinVis.dataLength - 1) curVal = BinVis.dataLength - 1;

                    if (curVal.toString() != o.value) {
                        o.value = curVal.toString();
                        offset_slider_changed();
                    }
                }

            }

        </script>

        <link type="text/css" rel="stylesheet" href="css/main.css" />
    </head>
    <body onload="init()">
        <div id="main-container">
            <div id="header"><h4>Header</h4></div>
            <div id="top-menu" class="hmenu">

                <!-- Upload button -->
                <a onclick="uploadInvoke()"><img class="button" src="img/uploadicon.png" alt="Upload File" /></a>
                
                <!-- Offset configuration -->
                <span id="offset-slider-container" style="display:none">
                    <span>Offset: </span>
                    <input type="range" id="offset-slider" min="0" max="100" value="0"/>
                    <input type="text" id="offset-text" value="0"/>
                 </span>
            </div>
            <div id="top-menu-2" class="hmenu">
                <div id="menu-bytemap">
                    
                </div>
            </div>
            <div id="main-body">
                <div id="context-menu"></div>
                <div id="panel-div">
                    <!-- Visual Panel -->
                    <div id="visual-panel-canvas">
                         <canvas id="main-canvas" width="512" height="512"></canvas>
                    </div>

                    <!-- Hex Viewer -->
                    <div id="hex-viewer">
                        <div id="hex-viewer-offset" class="offset columnar"></div>
                        <div id="hex-viewer-hex" class="hex columnar display-window"></div>
                        <div id="hex-viewer-text" class="text columnar display-window"></div>
                        <div id="hex-viewer-scrollbar" class="scrollbar">
                            <div id="scroll-up"></div>
                            <div id="scroll-bottom"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="buffer-container">
            <input type="file" id="upload-file" />
        </div>
    </body>
</html>
